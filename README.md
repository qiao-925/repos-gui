# GitHub 仓库批量分类克隆脚本

**批量克隆 GitHub 仓库**，采用**双重并行加速**技术（应用层多仓库并发 + Git 层多连接传输），大幅提升克隆速度。支持**多种主题分类体系**（军事高地、宝可梦、奥特曼、铠甲勇士等，如皮肤般可切换），实现仓库的智能分类与高效管理。

## 一、🚀 快速开始

1. **安装 Python**（需要 Python 3.7+）：
   ```bash
   # 检查 Python 版本
   python --version
   ```

2. **安装脚本**（注册 `repos` 命令）：
   ```bash
   # 在项目目录下执行
   pip install -e .
   ```
   
   安装完成后，可以在任何目录使用 `repos` 命令。

3. **创建分类文档**（使用 AI 辅助）：
   - 打开 `GitHub 仓库分类 Prompt.md`
   - 在 Cursor 中执行：`@GitHub 仓库分类 Prompt.md 执行当前prompt`
   - 确认后保存为 `REPO-GROUPS.md`

4. **开始克隆**：
   ```bash
   # 使用默认参数，从 REPO-GROUPS.md 解析所有仓库
   # 支持增量更新：自动跳过已存在且完整的仓库
   # 克隆完成后会自动检查仓库完整性
   repos
   # 或者
   repos clone
   ```

> 💡 **提示**：如果不想安装，也可以直接使用 `python main.py`，但需要切换到项目目录。

## 二、📋 常用命令速查

> **最常用的命令都在这里，快速查找，直接使用！**

#### 基础克隆命令
```bash
# 使用默认参数，从 REPO-GROUPS.md 解析所有仓库（最常用）
# 支持增量更新：自动跳过已存在且完整的仓库
repos
repos clone

# 自定义并行参数（推荐：高带宽使用）
repos clone -t 10 -c 16

# 从失败列表重新执行失败的仓库
repos clone -f failed-repos.txt

# 从自定义列表文件执行
repos clone -f custom-list.md
```

> 💡 **提示**：`clone` 命令支持增量更新，会自动检查仓库是否存在且完整。如果仓库已存在且完整，会跳过克隆；如果不存在或不完整，会执行克隆。克隆完成后会自动检查所有仓库的完整性。

---

## 三、🎯 核心特点

### 🚀 一键批量克隆
**核心功能**：自动扫描所有分组，批量克隆所有仓库，无需手动逐个操作。

### ⚡ 双重并行加速
**性能优势**：应用层并行（同时克隆多个仓库，默认 5 并发）+ Git 层并行传输（每个仓库多连接，默认 8 连接），双重叠加充分利用网络带宽，大幅提升克隆速度。

### 🚀 智能协议选择与 Git 优化
**性能优化**：自动选择最优协议（SSH 优先，回退到 HTTPS）+ Git 配置优化（HTTP/2、大缓冲区、多线程压缩），在高带宽环境下可提升 25-55% 的克隆速度。

### 📁 高效组织管理
**清晰结构**：每个分组自动创建独立文件夹（格式：`组名 (主题标签)`），所有仓库按分组清晰组织。

### 🎨 多种主题分类体系
**独特特色**：支持多种主题分类体系（军事高地、宝可梦、奥特曼、铠甲勇士等，如皮肤般可切换），为分组添加有趣的标签作为代号，增强记忆和识别度。可根据个人喜好选择不同的主题体系。

### 🎯 极简设计
**设计理念**：保持极简，只保留核心功能，去除所有非必要的复杂逻辑，易于理解和维护。

### 📝 任务列表文件支持
**灵活控制**：支持从文件读取任务列表，可以执行全量仓库、失败列表或自定义列表。脚本不关心输入来源，只负责执行任务列表，保持纯粹性。

### ✅ 仓库完整性检查与增量更新
**质量保证**：克隆前自动检查仓库是否存在且完整，存在且完整则跳过克隆；克隆完成后自动使用 `git fsck` 检查仓库完整性，确保克隆的仓库可用。实现增量更新，避免重复克隆。

## 四、⚙️ 自定义参数

### 并发参数配置

#### clone 子命令参数

- **`-t, --tasks NUM`**：并行任务数（同时克隆的仓库数量，默认: 5）
- **`-c, --connections NUM`**：并行传输数（每个仓库的 Git 连接数，默认: 8）
- **`-f, --file FILE`**：指定任务列表文件（如果不指定，默认从 REPO-GROUPS.md 解析）

#### check 子命令参数

- **`-t, --tasks NUM`**：并行任务数（同时检查的仓库数量，默认: 5）
- **`-f, --file FILE`**：指定任务列表文件（如果不指定，默认从 REPO-GROUPS.md 解析）

#### 推荐配置

根据你的网络带宽选择合适的配置：

- **低带宽（< 10Mbps）**：`repos clone -t 3-5 -c 4-8`
- **中带宽（10-50Mbps）**：`repos clone -t 5-10 -c 8-12`
- **高带宽（50-200Mbps）**：`repos clone -t 10-15 -c 16-24`
- **超高带宽（> 200Mbps，如 300Mbps）**：`repos clone -t 15-20 -c 24-32`

> 💡 **提示**：所有命令示例已集中在[第二章：常用命令速查](#二常用命令速查)，可直接查看使用。

### 任务列表文件功能

#### 功能说明

脚本支持从文件读取任务列表，实现灵活的任务控制：

1. **默认模式**：不指定 `-f` 参数时，从 `REPO-GROUPS.md` 解析所有仓库
2. **文件模式**：指定 `-f` 参数时，从指定文件读取任务列表（REPO-GROUPS.md 格式）
3. **失败列表**：执行完成后，失败的仓库自动保存到 `failed-repos.txt`（REPO-GROUPS.md 格式，可直接用 `-f` 参数重新执行）

#### 任务列表文件格式

**统一使用 REPO-GROUPS.md 格式**，所有输入文件（包括失败列表）都使用相同格式，脚本统一用 `parse_repo_groups()` 解析。

格式示例：
```markdown
# GitHub 仓库分组

仓库所有者: qiao-925

## Go-Practice <!-- 397.8号高地 -->
- go-admin
- JavaGuide

## Java-Practice <!-- 597.9号高地 -->
- incubator-seata
- distribute-transaction
```

#### 使用场景

1. **重新执行失败的仓库**：使用 `repos clone -f failed-repos.txt`（详见[常用命令速查](#二常用命令速查)）
2. **执行自定义仓库列表**：使用 `repos clone -f custom-list.md`（详见[常用命令速查](#二常用命令速查)）
3. **分批执行**：将大量仓库分成多个列表文件，分别执行（详见[常用命令速查](#二常用命令速查)）

## 五、✅ 仓库完整性检查

### 功能说明

脚本提供仓库完整性检查功能，使用 `git fsck` 验证克隆后的仓库是否可用。确保仓库对象完整、引用有效，及时发现损坏的仓库。

### 检查原理

**`git fsck`（File System Check）** 是 Git 的完整性检查工具：

1. **SHA-1 哈希校验**：验证每个 Git 对象（commit、tree、blob、tag）的 SHA-1 哈希值，确保对象内容完整
2. **对象连接性检查**：验证对象之间的引用关系，检查是否有缺失或损坏的对象
3. **引用完整性**：检查分支、标签等引用是否指向有效对象

### 检查时机

脚本在以下时机自动检查仓库完整性：

1. **克隆前检查**：执行 `clone` 命令时，会先检查仓库是否存在且完整
   - 如果仓库已存在且完整，跳过克隆
   - 如果仓库不存在或不完整，执行克隆
   - 实现增量更新，避免重复克隆

2. **克隆后检查**：克隆完成后，自动检查所有成功克隆的仓库（包括跳过克隆的）
   - 默认启用，无需额外参数
   - 并行检查，不影响克隆速度
   - 检查失败的仓库会被标记为失败，加入失败列表

### 使用方式

- **自动检查（默认）**：执行 `clone` 命令时，会自动进行克隆前检查和克隆后检查
- **增量更新**：已存在且完整的仓库会自动跳过，无需手动检查

> 💡 **提示**：所有命令示例已集中在[第二章：常用命令速查](#二常用命令速查)，可直接查看使用。

### 检查结果

- **检查通过**：仓库完整性正常，可以正常使用
- **检查失败**：仓库可能损坏，会被加入失败列表，可以重新克隆

### 注意事项

- `git fsck` 会忽略 `dangling objects` 警告（这是正常的，不算错误）
- 检查超时时间默认为 30 秒，大仓库可能需要更长时间
- 检查失败的仓库会被标记为失败，建议重新克隆

## 六、📐 架构设计

### 核心设计原则

1. **极简优先**：只保留核心功能，去除所有非必要的复杂逻辑
2. **双重并行**：应用层并行（-t 参数） + Git 层并行传输（-c 参数）
3. **智能优化**：自动选择最优协议（SSH/HTTPS）+ Git 配置优化
4. **增量更新**：先检查仓库是否存在且完整，存在且完整则跳过克隆
5. **完整克隆**：全部使用完整克隆，不使用浅克隆

### 主要工作流程

```
开始 (main.py)
  │
  ├─→ [1] 解析命令行参数
  │     └─ parse_args() [lib/args.py]
  │         ├─ 解析子命令（clone 或 check）
  │         ├─ 解析 -t 参数（并行任务数，默认 5）
  │         ├─ 解析 -c 参数（并行传输数，默认 8，仅 clone）
  │         └─ 解析 -f 参数（任务列表文件，可选）
  │
  ├─→ [2] 获取任务列表
  │     ├─ 如果指定 -f 参数：从文件读取任务列表
  │     └─ 否则：解析 REPO-GROUPS.md，提取所有分组和仓库
  │         └─ parse_repo_groups() [lib/config.py]
  │
  ├─→ [3] 构建克隆任务列表
  │     └─ 任务格式：repo_full|repo_name|group_folder|group_name
  │
  ├─→ [4] 并行执行克隆（支持增量更新）
  │     └─ execute_parallel_clone() [lib/parallel.py]
  │         ├─ 使用 ThreadPoolExecutor 实现并行控制
  │         └─ 并行调用 clone_repo() [lib/clone.py]
  │             ├─ 克隆前检查：检查仓库是否存在且完整
  │             │   ├─ 如果存在且完整：跳过克隆
  │             │   └─ 如果不存在或不完整：执行克隆
  │             ├─ 自动选择协议（SSH 优先，回退到 HTTPS）
  │             ├─ 应用 Git 配置优化（HTTP/2、大缓冲区、多线程）
  │             └─ 使用 git clone --jobs $CONNECTIONS
  │
  ├─→ [5] 检查仓库完整性
  │     └─ 检查所有成功克隆的仓库（包括跳过克隆的）
  │         └─ check_repos_parallel() [lib/check.py]
  │             ├─ 并行检查所有成功克隆的仓库
  │             └─ 使用 git fsck --strict 验证完整性
  │
  ├─→ [6] 记录失败列表
  │     └─ 将克隆失败和检查失败的仓库保存到 failed-repos.txt
  │         └─ save_failed_repos() [lib/failed_repos.py]
  │
  └─→ [7] 输出最终统计
        └─ print_summary() [main.py]
            ├─ 显示成功/失败统计
            └─ 显示耗时统计
```

### 模块化架构

```
main.py (主入口)
  │
  ├── lib/logger.py (日志输出)
  ├── lib/config.py (配置解析)
  ├── lib/clone.py (仓库克隆)
  ├── lib/parallel.py (并行控制)
  ├── lib/failed_repos.py (失败列表生成)
  ├── lib/args.py (参数解析)
  ├── lib/paths.py (路径处理)
  └── lib/check.py (仓库完整性检查)
```

**模块依赖关系**: logger → config/clone → main

**核心函数**:
- `parse_repo_groups()`: 解析配置文件，提取分组和仓库信息
- `clone_repo()`: 克隆单个仓库，支持增量更新（先检查仓库是否存在且完整），使用 Git 并行传输参数
- `execute_parallel_clone()`: 并行执行克隆任务
- `check_repo()`: 检查单个仓库的完整性（git fsck）
- `check_repos_parallel()`: 并行检查多个仓库
- `print_summary()`: 输出最终统计报告

### 代码统计

#### Python 版本文件列表

| 文件 | 行数 | 功能说明 |
|------|------|----------|
| `main.py` | 177 | **主入口**：解析命令行参数、协调各模块执行、统计报告 |
| `lib/config.py` | 132 | **配置解析模块**：解析 REPO-GROUPS.md，提取分组和仓库信息 |
| `lib/clone.py` | 240 | **仓库克隆模块**：实现单个仓库克隆，使用 --jobs 参数 |
| `lib/parallel.py` | 75 | **并行控制模块**：使用 ThreadPoolExecutor 实现并行克隆 |
| `lib/failed_repos.py` | 110 | **失败列表生成模块**：生成 REPO-GROUPS.md 格式的失败列表 |
| `lib/logger.py` | 66 | **日志输出模块**：提供统一的日志输出功能 |
| `lib/args.py` | 97 | **参数解析模块**：命令行参数解析和验证 |
| `lib/paths.py` | 59 | **路径处理模块**：跨平台路径处理 |
| `lib/check.py` | 126 | **仓库完整性检查模块**：使用 git fsck 验证仓库完整性 |
| **总计** | **1082** | **9 个文件** |

