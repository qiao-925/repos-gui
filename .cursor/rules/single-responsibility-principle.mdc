---
description: "单一职责原则：确保代码文件、函数、模块职责清晰单一"
globs:
  - "**/*.sh"
  - "**/*.js"
  - "**/*.ts"
  - "**/*.py"
  - "**/*.java"
  - "**/*.go"
alwaysApply: true
priority: 2
---

# 单一职责原则（Single Responsibility Principle）

## 核心原则

**每个文件、函数、模块应该只负责一个明确的功能或职责，保持职责单一、清晰、易于理解。**

## 为什么重要

- **降低认知负担**：单一职责的代码更容易理解和维护
- **提高可读性**：清晰的职责划分让代码结构一目了然
- **便于测试**：单一职责的代码更容易编写单元测试
- **减少耦合**：职责分离有助于降低模块间的依赖关系
- **易于重构**：当需求变化时，只需修改相关的单一职责模块

## 强制要求

### 1. 文件级别职责划分

**每个代码文件应该只负责一个功能领域或业务模块。**

#### 检查标准

- [ ] 文件的主要功能可以用一句话清晰描述
- [ ] 文件中的所有函数/类都与这个主要功能相关
- [ ] 如果文件包含多个不相关的功能，应该考虑拆分

#### 拆分建议

当发现文件职责不清晰时，应该：

1. **识别功能边界**：分析文件中的功能，识别可以独立的功能模块
2. **与用户讨论**：主动询问用户如何划分职责更合理
3. **提供拆分方案**：给出具体的拆分建议，包括：
   - 建议拆分为哪些文件
   - 每个文件应该包含哪些功能
   - 文件间的依赖关系

### 2. 函数级别职责划分

**每个函数应该只做一件事，并且做好。**

#### 检查标准

- [ ] 函数名能够清晰表达函数的单一职责
- [ ] 函数内部逻辑围绕一个明确的目标
- [ ] 如果函数包含多个不相关的操作，应该考虑拆分

#### 拆分原则

- **数据获取与处理分离**：获取数据的函数和处理数据的函数分开
- **验证与执行分离**：参数验证、业务逻辑、结果处理分开
- **计算与输出分离**：计算逻辑和格式化输出分开

### 3. 模块级别职责划分

**模块应该按照业务领域或技术层次进行划分。**

#### 常见划分方式

- **按业务领域**：用户管理、订单处理、支付处理等
- **按技术层次**：数据访问层、业务逻辑层、表现层等
- **按功能类型**：工具函数、配置管理、日志记录等

## AI Agent 行为要求

### 1. 创建代码时

**必须主动考虑职责划分：**

1. **分析需求**：理解用户需求，识别需要实现的功能模块
2. **职责规划**：在编码前规划好文件、函数、模块的职责边界
3. **主动询问**：如果不确定如何划分职责，主动与用户讨论
4. **提供方案**：给出职责划分的建议方案，说明理由

### 2. 修改代码时

**必须检查职责是否清晰：**

1. **评估现有结构**：检查当前代码的职责划分是否合理
2. **识别问题**：如果发现职责混乱，主动指出问题
3. **提出建议**：提供重构建议，说明如何改进职责划分
4. **征得同意**：在拆分重构前，与用户确认拆分方案

### 3. 代码审查时

**必须检查单一职责原则：**

1. **文件职责检查**：检查文件是否包含多个不相关的功能
2. **函数职责检查**：检查函数是否做了多件事
3. **模块职责检查**：检查模块间的职责边界是否清晰
4. **提出改进建议**：如果发现问题，提供具体的改进建议

## 职责划分决策流程

当遇到职责划分不清晰的情况时，遵循以下流程：

```
1. 识别问题
   ↓
2. 分析功能边界
   ↓
3. 与用户讨论划分方案
   ↓
4. 提供拆分建议（包括文件结构、依赖关系）
   ↓
5. 获得用户确认后执行拆分
   ↓
6. 验证拆分后的代码职责清晰
```

## 拆分建议模板

当检测到职责不清晰时，应提供如下格式的建议：

```
⚠️ 职责划分建议

当前问题：
- [文件/函数/模块名] 包含了多个不相关的职责
- 具体问题描述

建议拆分方案：

1. [新文件/函数/模块名1]
   - 职责：[单一职责描述]
   - 包含内容：[具体功能列表]
   - 依赖关系：[依赖说明]

2. [新文件/函数/模块名2]
   - 职责：[单一职责描述]
   - 包含内容：[具体功能列表]
   - 依赖关系：[依赖说明]

拆分理由：
- 理由1
- 理由2

是否执行拆分？
```

## 示例

### ✅ 好的示例：职责清晰

```bash
# lib/logger.sh - 日志记录模块
# 职责：提供统一的日志记录功能
# 包含：日志级别、格式化、输出控制

log_info() { ... }
log_error() { ... }
log_debug() { ... }
```

```bash
# lib/config.sh - 配置管理模块
# 职责：管理应用配置
# 包含：配置加载、验证、缓存

load_config() { ... }
validate_config() { ... }
get_config_value() { ... }
```

### ❌ 不好的示例：职责混乱

```bash
# lib/utils.sh - 工具函数模块（职责混乱）
# 包含了日志、配置、克隆、数据处理等多种不相关功能

log_info() { ... }           # 日志功能
load_config() { ... }        # 配置功能
clone_repo() { ... }         # 克隆功能
format_date() { ... }        # 数据处理功能
```

**改进建议**：拆分为 `logger.sh`、`config.sh`、`clone.sh` 等独立模块

## 例外情况

以下情况可以适当放宽单一职责要求：

1. **工具函数集合**：如果文件明确是工具函数集合，且函数都是简单、独立的工具函数
2. **配置常量文件**：只包含常量定义的文件
3. **测试文件**：测试文件可以包含多个测试用例

但即使在这些情况下，也应该保持逻辑上的内聚性。

## 维护建议

- 定期审查代码，检查职责划分是否清晰
- 在添加新功能时，优先考虑是否应该创建新文件/函数
- 当文件/函数变得复杂时，主动考虑拆分
- 保持与用户的沟通，确保职责划分符合项目需求

## 重要提醒

**单一职责原则是提高代码质量的基础原则。**
**在 AI 辅助开发时，主动考虑职责划分，与用户协作创建清晰、可维护的代码结构。**
