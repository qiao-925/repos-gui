---
description: "脚本代码全局性自检规范"
globs:
  - "main.sh"
alwaysApply: true
priority: 1
---

# 脚本代码全局性自检规范

## 核心原则

**代码更改后必须进行全局性检查** ⚠️ **极其重要**

每次涉及 `main.sh` 的代码更改后，必须使用 AI Agent 对整个脚本进行全面的全局性分析检查，确保代码质量和正确性。

## 强制要求

1. **每次代码更改后必须执行全局性检查**
2. **如果检查发现问题，必须立即修复，不得延迟**
3. **检查完成且无问题后才能提交代码**

## 全局检查清单 ⚠️ **强制执行**

使用 AI Agent 对脚本进行全局性分析，必须检查以下所有项目：

### 1. 语法和基础检查
- [ ] 运行语法检查：`bash -n main.sh`（或等效检查）
- [ ] 运行 Linter 检查：确保无 linter 错误
- [ ] 检查所有引用的变量是否已定义
- [ ] 检查所有函数调用参数是否正确
- [ ] 验证所有函数是否正确定义和导出

### 2. 并行化相关检查（如果涉及并行代码）
- [ ] 检查并行执行块中的变量作用域是否正确
- [ ] 验证子shell中所有变量是否正确定义和传递
- [ ] 检查并发控制逻辑是否正确
- [ ] 验证日志文件和结果汇总逻辑
- [ ] 确认并行执行不会导致数据竞争或死锁

### 3. 路径和目录结构检查
- [ ] 验证所有路径构建是否一致（使用 `get_group_folder()`）
- [ ] 检查目录创建逻辑是否正确
- [ ] 确认相对路径和绝对路径使用正确
- [ ] 验证路径拼接不会导致路径错误
- [ ] 检查所有文件/目录操作是否安全

### 4. 函数逻辑检查
- [ ] 检查函数参数传递是否正确
- [ ] 验证错误处理逻辑是否完整
- [ ] 确认返回值处理正确
- [ ] 检查函数调用链是否完整
- [ ] 验证函数依赖关系是否正确

### 5. 错误处理检查
- [ ] 验证所有关键操作都有错误处理
- [ ] 检查错误退出码是否正确
- [ ] 确认错误信息清晰明确
- [ ] 验证重试逻辑（如有）是否正确

### 6. 数据一致性检查
- [ ] 检查全局变量初始化是否正确
- [ ] 验证缓存机制是否正确
- [ ] 确认数据同步逻辑正确
- [ ] 检查数据清理逻辑是否完整

### 7. 问题修复要求
- [ ] **如果发现任何问题，必须立即修复，不得跳过或延迟**
- [ ] 修复后重新执行上述检查，直到所有检查通过
- [ ] 确认修复不会引入新问题
- [ ] 验证修复后的代码逻辑完整性

## AI Agent 检查方式

使用 AI Agent 进行全局性分析时，应该：

1. **全面扫描**：读取整个脚本文件，理解整体架构
2. **逻辑分析**：分析执行流程、函数调用关系、数据流转
3. **静态检查**：检查语法、变量作用域、函数定义
4. **动态分析**：分析执行路径、错误处理流程、并发控制
5. **一致性验证**：验证代码与文档的一致性

## 检查工具和方法

- 语法检查：`bash -n main.sh`
- Linter：使用 shellcheck 或其他 shell linter
- 代码分析：使用 AI Agent 进行语义分析和逻辑检查
- 手动审查：关键逻辑需要人工审查

## 重要提醒

**代码自检是确保脚本质量的关键步骤。**
**在 AI 时代，代码生成速度快，但错误也可能快速传播。**
**严格的全局性检查是防止问题扩散的重要防线。**
